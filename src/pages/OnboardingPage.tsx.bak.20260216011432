import React from 'react';
import { useEffect } from "react";
import { useNavigate } from "react-router-dom";

export default function OnboardingPage() {
  // AUTO-REDIRECT: approved players skip onboarding
  // If user has player_auth_link AND at least one alliance assignment, send them to personal dashboard.
  const navigate = useNavigate();

  useEffect(() => {
    let cancelled = false;

    (async () => {
      try {
        const { data: userRes } = await supabase.auth.getUser();
        const user = userRes?.user;
        if (!user) return;

        // Get player_id linked to this auth user
        const { data: links, error: linkErr } = await supabase
          .from("player_auth_links")
          .select("player_id")
          .eq("user_id", user.id)
          .limit(1);

        if (linkErr) return;
        const playerId = (links && links.length > 0) ? (links[0] as any).player_id : null;
        if (!playerId) return;

        // Confirm they are assigned to at least one alliance
        const { data: mems, error: memErr } = await supabase
          .from("player_alliances")
          .select("id")
          .eq("player_id", playerId)
          .limit(1);

        if (memErr) return;
        const hasAlliance = !!(mems && mems.length > 0);

        if (!cancelled && hasAlliance) {
          navigate("/me", { replace: true });
        }
      } catch {
        // ignore
      }
    })();

    return () => { cancelled = true; };
  }, [navigate]);

  return (
    <div style={{ padding: '2rem' }}>
      <h1>Alliance Onboarding</h1>
      <p>Your account is active, but you are not part of an alliance yet.</p>
      <p>Please submit an onboarding request.</p>
    </div>
  );
}

